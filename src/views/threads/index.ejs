<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Community · CP KKU Study Notes</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    *{
      box-sizing: border-box !important; 
    }
    :root {
      --brand: #0d63a5;
      --muted: #6b7280;
      --border: #e5e7eb;
      --bg: #fff;
    }

    .wrap {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px
    }

    /* header + search */
    .head {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 10px;
      margin-left: 0.3rem;
    }

    .head h2 {
      margin: 0;
      font-size: 2rem;
      color: #0f3d7a
    }

    .head p {
      margin: .25rem 0 0;
      color: var(--muted)
    }

    .new-btn {
      display: inline-flex;
      gap: 8px;
      justify-content: center;
      padding: 8px 12px;
      border-radius: 10px;
      background: var(--brand);
      color: #fff;
      text-decoration: none;
      border: 1px solid var(--brand);
      margin-top: 10px;
    }

    .new-btn:hover {
      filter: brightness(.96)
    }

    .new-btn svg path {
      fill: currentColor
    }

    .searchbar {
      display: flex;
      gap: 8px;
      align-items: center;
      margin: 8px 0 14px
    }

    .searchbar input[type="search"] {
      min-width: 220px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      outline: none;
      background: #fff;
      box-sizing: border-box;
    }

    .searchbar input[type="search"]:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(13, 99, 165, .12);
      box-sizing: border-box;

    }

    .btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #f9fafb;
      color: #374151;
      cursor: pointer
    }

    .btn.primary {
      border-color: var(--brand);
      background: var(--brand);
      color: #fff
    }

    /* feed list */
    .feed {
      display: flex;
      flex-direction: column;
      gap: 12px;
      /* ระยะห่างระหว่างบล็อก */
      border: 0;
      background: transparent;
      overflow: visible;
      /* ให้เงาของการ์ดไม่โดนตัด */
    }

    /* ลิงก์ทั้งแผ่น + hover */
    .item {
      display: block;
      padding: 16px 14px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      text-decoration: none;
      color: inherit;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .04);
      transition:
        transform .12s ease,
        box-shadow .12s ease,
        border-color .12s ease,
        background .12s ease;
      cursor: pointer;
    }

    .item:last-child {
      border-bottom: 1px solid var(--border);
    }

    /* จะลบทั้งบรรทัดนี้ก็ได้ */

    /* Hover ให้ลอยขึ้นนิด ๆ */
    .item:hover {
      transform: translateY(-2px);
      border-color: #dbeafe;
    }

    /* โฟกัสด้วยคีย์บอร์ด */
    .item:focus-visible {
      outline: 3px solid rgba(13, 99, 165, .35);
      outline-offset: 3px;
      border-color: #93c5fd;
    }

    .meta-top {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      color: var(--muted);
      font-size: .92rem
    }

    .post-time {
      white-space: nowrap;
      margin-left: auto;
    }

    .meta-top .name {
      color: #0d63a5;
      font-weight: 600
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 9999px;
      font-size: .75rem;
      font-weight: 700;
      border: 1px solid #bae6fd;
      background: #e0f2fe;
      color: #075985;
    }

    .meta-top .cat {
      color: #374151
    }

    .meta-top .sep {
      color: #9ca3af
    }

    .title-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin: 4px 0 6px
    }

    .title {
      margin: 0;
      font-weight: 800;
      font-size: 1.05rem;
      color: #111827;
      line-height: 1.4
    }

    .excerpt {
      margin: 0;
      color: #374151;
      line-height: 1.55;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      overflow: hidden
    }

    .stats {
      display: flex;
      align-items: center;
      gap: 14px;
      color: #6b7280;
      margin-top: 8px;
      font-size: .92rem
    }

    .stat {
      display: inline-flex;
      gap: 6px;
      align-items: center
    }

    .stat svg {
      width: 16px;
      height: 16px;
      vertical-align: middle
    }

    .stat svg path {
      fill: currentColor
    }

    .timeago {
      white-space: nowrap
    }

    /* FAB (มือถือ) */
    .fab {
      position: fixed;
      right: 20px;
      bottom: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--brand);
      color: #fff;
      border: none;
      box-shadow: 0 8px 20px rgba(13, 99, 165, .25);
      text-decoration: none
    }

    .fab:hover {
      filter: brightness(.96)
    }

    .fab svg path {
      fill: currentColor
    }
  </style>
</head>

<body>
  <main class="wrap">
    <div class="head">
      <div>
        <h2>Community Feed</h2>
        <p>ถาม–ตอบ แลกเปลี่ยนความรู้</p>
      </div>

      <% if (currentUser){ %>
        <a href="/threads/new" class="new-btn">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
            <path d="M11 5a1 1 0 0 1 2 0v6h6a1 1 0 1 1 0 2h-6v6a1 1 0 1 1-2 0v-6H5a1 1 0 1 1 0-2h6V5z" />
          </svg>
          ตั้งหัวข้อใหม่
        </a>
        <% } %>

    </div>

    <% var _q=(typeof q !=='undefined' && q) ? q : '' ; %>
      <form class="searchbar" method="get" action="/community">
        <input type="search" name="q" placeholder="ค้นหาหัวข้อ/คำสำคัญ…" value="<%= _q %>" />
        <button class="btn primary" type="submit">
          <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="bi bi-search"
            viewBox="0 0 16 16">
            <path
              d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0" />
          </svg>
          ค้นหา
        </button>
      </form>

      <% if (_q && threads && threads.length===0){ %>
        <p class="muted">ไม่พบผลลัพธ์สำหรับ “<%= _q %>”</p>
        <% } %>

          <section class="feed" aria-label="community feed">
            <% var SHOW_EXCERPT=true; if (threads && threads.length) { for (var i=0; i < threads.length; i++) { var
              t=threads[i]; if (t && t.deleted) { continue; } var replies=(t.replies && t.replies.length) ?
              t.replies.length : 0; var likes=(t.likes && t.likes.length) ? t.likes.length : 0; var views=(typeof
              t.views==='number' ) ? t.views : 0; var created=t.updatedAt || t.createdAt || Date.now(); var
              username=(t.author && t.author.username) ? t.author.username : 'ผู้ใช้' ; var program=(t.author &&
              t.author.program) ? t.author.program : '' ; var year=(t.author && t.author.year) ? t.author.year : '' ;
              var progYear='' ; if (program) { progYear=program; } if (year) { if (progYear) { progYear=progYear
              + ' · ปี ' + year; } else { progYear='ปี ' + year; } } var category=t.category || t.tag || '' ; %>
              <!-- คลิกได้ทั้งแถว -->
              <a class="item" href="/threads/<%= t._id %>" aria-label="เปิดหัวข้อ: <%= t.title %>">
                <div class="meta-top">
                  <span class="name">
                    <%= username %>
                  </span>
                  <% if (progYear) { %><span class="chip">
                      <%= progYear %>
                    </span>
                    <% } %>
                      <% if (category) { %><span class="sep">•</span><span class="cat">โพสต์ใน <strong>
                            <%= category %>
                          </strong></span>
                        <% } %>
                          <span class="post-time" data-time="<%= new Date(t.createdAt).toISOString() %>"></span>

                </div>

                <div class="title-row">
                  <h3 class="title"><span>
                      <%= t.title %>
                    </span></h3>

                </div>

                <% if (SHOW_EXCERPT && t.body) { %>
                  <p class="excerpt">
                    <%= t.body %>
                  </p>
                  <% } %>

                    <div class="stats">
                      <span class="stat" title="ถูกใจ">
                        <svg viewBox="0 0 16 16" aria-hidden="true">
                          <path d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314" />
                        </svg>
                        <span>
                          <%= likes %>
                        </span>
                      </span>
                      <span class="stat" title="ความเห็น">
                        <svg viewBox="0 0 16 16" aria-hidden="true">
                          <path
                            d="M8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6-.097 1.016-.417 2.13-.771 2.966-.079.186.074.394.273.362 2.256-.37 3.597-.938 4.18-1.234A9 9 0 0 0 8 15" />
                        </svg>
                        <span>
                          <%= replies %>
                        </span>
                      </span>
                      <span class="stat" title="จำนวนดู">
                        <svg viewBox="0 0 16 16" aria-hidden="true">
                          <path
                            d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8m8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7" />
                        </svg>
                        <span>
                          <%= views %>
                        </span>
                      </span>
                    </div>
              </a>
              <% } /* end for */ } /* end if threads */ %>
          </section>
  </main>

  <% if (currentUser){ %>
    <a href="/threads/new" class="fab" aria-label="ตั้งหัวข้อใหม่">
      <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true">
        <path d="M11 5a1 1 0 0 1 2 0v6h6a1 1 0 1 1 0 2h-6v6a1 1 0 1 1-2 0v-6H5a1 1 0 1 1 0-2h6V5z" />
      </svg>
    </a>
    <% } %>
      <script>
        (function () {
          function timeAgo(input) {
            const date = new Date(input);
            const diffSec = Math.round((Date.now() - date.getTime()) / 1000);
            const abs = Math.abs(diffSec);
            if (abs < 45) return diffSec >= 0 ? "เมื่อสักครู่" : "อีกสักครู่";
            const units = [
              { s: 31536000, k: "ปี" },
              { s: 2592000, k: "เดือน" },
              { s: 604800, k: "สัปดาห์" },
              { s: 86400, k: "วัน" },
              { s: 3600, k: "ชั่วโมง" },
              { s: 60, k: "นาที" },
              { s: 1, k: "วินาที" },
            ];
            for (const u of units) {
              if (abs >= u.s) {
                const n = Math.floor(abs / u.s);
                return diffSec >= 0 ? `${n} ${u.k}` : ` ${n} ${u.k}`;
              }
            }
            return "เมื่อสักครู่";
          }

          function updateAll() {
            document.querySelectorAll('.post-time[data-time]').forEach(el => {
              el.textContent = timeAgo(el.getAttribute('data-time'));
            });
          }

          updateAll();
          setInterval(updateAll, 60000); // อัปเดตทุก 1 นาที
        })();
      </script>

</body>

</html>