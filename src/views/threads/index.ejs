<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Community ¬∑ CP KKU Study Notes</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    :root {
      --brand: #0d63a5;
      --muted: #6b7280;
      --border: #e5e7eb;
      --bg: #fff;
    }

    .title-wrapper {
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .title-wrapper .post-time {
      margin-left: auto;
      white-space: nowrap;
    }


    .wrap {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px
    }

    /* header + search */
    .head {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 10px;
      margin-left: 0.3rem;
    }

    .head h2 {
      margin: 0;
      font-size: 2rem;
      color: #0f3d7a
    }

    .head p {
      margin: .25rem 0 0;
      color: var(--muted)
    }

    .new-btn {
      display: inline-flex;
      gap: 8px;
      justify-content: center;
      padding: 8px 12px;
      border-radius: 10px;
      background: var(--brand);
      color: #fff;
      text-decoration: none;
      border: 1px solid var(--brand);
      margin-top: 10px;
    }

    .new-btn:hover {
      filter: brightness(.96)
    }

    .new-btn svg path {
      fill: currentColor
    }

    .searchbar {
      display: flex;
      gap: 8px;
      align-items: center;
      margin: 8px 0 14px
    }

    .searchbar input[type="search"] {
      flex: 1;
      min-width: 220px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      outline: none;
      background: #fff
    }

    .searchbar input[type="search"]:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(13, 99, 165, .12)
    }

    .btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #f9fafb;
      color: #374151;
      cursor: pointer
    }

    .btn.primary {
      border-color: var(--brand);
      background: var(--brand);
      color: #fff
    }

    /* feed list */
    .feed {
      display: flex;
      flex-direction: column;
      gap: 12px;
      /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏•‡πá‡∏≠‡∏Å */
      border: 0;
      background: transparent;
      overflow: visible;
      /* ‡πÉ‡∏´‡πâ‡πÄ‡∏á‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô‡∏ï‡∏±‡∏î */
    }

    /* ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ú‡πà‡∏ô + hover */
    .item {
      display: block;
      padding: 16px 14px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      text-decoration: none;
      color: inherit;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .04);
      transition:
        transform .12s ease,
        box-shadow .12s ease,
        border-color .12s ease,
        background .12s ease;
      cursor: pointer;
    }

    .item:last-child {
      border-bottom: 1px solid var(--border);
    }

    /* ‡∏à‡∏∞‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏Å‡πá‡πÑ‡∏î‡πâ */

    /* Hover ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î ‡πÜ */
    .item:hover {
      transform: translateY(-2px);
      border-color: #dbeafe;
    }

    /* ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î */
    .item:focus-visible {
      outline: 3px solid rgba(13, 99, 165, .35);
      outline-offset: 3px;
      border-color: #93c5fd;
    }

    .meta-top {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      color: var(--muted);
      font-size: .92rem
    }

    .post-time {
      white-space: nowrap;
      margin-left: auto;
    }

    .meta-top .name {
      color: #0d63a5;
      font-weight: 600
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 9999px;
      font-size: .75rem;
      font-weight: 700;
      border: 1px solid #bae6fd;
      background: #e0f2fe;
      color: #075985;
    }

    .meta-top .cat {
      color: #374151
    }

    .meta-top .sep {
      color: #9ca3af
    }

    .title-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin: 4px 0 6px
    }

    .title {
      margin: 0;
      font-weight: 800;
      font-size: 1.05rem;
      color: #111827;
      line-height: 1.4
    }

    .excerpt {
      margin: 0;
      color: #374151;
      line-height: 1.55;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      overflow: hidden
    }

    .stats {
      display: flex;
      align-items: center;
      gap: 14px;
      color: #6b7280;
      margin-top: 8px;
      font-size: .92rem
    }

    .stat {
      display: inline-flex;
      gap: 6px;
      align-items: center
    }

    .stat svg {
      width: 16px;
      height: 16px;
      vertical-align: middle
    }

    .stat svg path {
      fill: currentColor
    }

    .timeago {
      white-space: nowrap
    }

    /* FAB (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠) */
    .fab {
      position: fixed;
      right: 20px;
      bottom: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--brand);
      color: #fff;
      border: none;
      box-shadow: 0 8px 20px rgba(13, 99, 165, .25);
      text-decoration: none
    }

    .fab:hover {
      filter: brightness(.96)
    }

    .fab svg path {
      fill: currentColor
    }
  </style>
</head>

<body>
  <main class="wrap">
    <div class="head">
      <div>
        <h2>Community Feed</h2>
        <p>‡∏ñ‡∏≤‡∏°‚Äì‡∏ï‡∏≠‡∏ö ‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ</p>
      </div>

      <% if (currentUser){ %>
        <a href="/threads/new" class="new-btn">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
            <path d="M11 5a1 1 0 0 1 2 0v6h6a1 1 0 1 1 0 2h-6v6a1 1 0 1 1-2 0v-6H5a1 1 0 1 1 0-2h6V5z" />
          </svg>
          ‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà
        </a>
        <% } %>

    </div>

    <% var _q=(typeof q !=='undefined' && q) ? q : '' ; %>
      <form class="searchbar" method="get" action="/community">
        <input type="search" name="q" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠/‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‚Ä¶" value="<%= _q %>" />
        <button class="btn primary" type="submit">
          <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="bi bi-search"
            viewBox="0 0 16 16">
            <path
              d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0" />
          </svg>
          ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        </button>
      </form>

      <% if (_q && threads && threads.length===0){ %>
        <p class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‚Äú<%= _q %>‚Äù</p>
        <% } %>

          <section class="feed grid" aria-label="community feed">
            <% (threads || []).forEach(t=> { if (!t || t.deleted) return; %>
              <div class="card-container">
                <a class="card" href="/threads/<%= t._id %>">
                  <% if (t.coverImage) { %>
                    <img src="<%= t.coverImage %>" class="cover" />
                    <% } else if (t.pdfFile) { %>
                      <div class="pdf-preview d-flex flex-column justify-content-center align-items-center"
                        style="height: 10px; background: #f8f9fa; border-radius: 10px;">
                        <span class="text-muted fs-5">üìÑ <%= t.title %>.pdf</span>
                      </div>
                      <% } %>

                        <div class="pad">
                          <div class="title-wrapper">
                            <h3 class="ellipsis meta-line">
                              <%= t.title %>
                            </h3>
                            <span class="post-time"
                              data-time="<%= new Date(t.updatedAt || t.createdAt || Date.now()).toISOString() %>"></span>
                          </div>

                          <p class="muted meta-line author">
                            by <%= (t.author && t.author.username) ? t.author.username : '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ' %>
                          </p>

                          <% if (t.body) { %>
                            <p class="muted excerpt">
                              <%= t.body %>
                            </p>
                            <% } %>

                              <p class="muted meta-line stats">
                                <% const likedByMe=currentUser && Array.isArray(t.likes) && t.likes.map(id=>
                                  String(id)).includes(String(currentUser.id)); %>

                                  <!-- heart -->
                                  <% if (likedByMe) { %>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon-inline bi bi-heart-fill"
                                      viewBox="0 0 16 16" aria-hidden="true" style="color:#DE3163;">
                                      <path fill="currentColor" fill-rule="evenodd"
                                        d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314" />
                                    </svg>
                                    <% } else { %>
                                      <svg xmlns="http://www.w3.org/2000/svg" class="icon-inline bi bi-heart-fill"
                                        viewBox="0 0 16 16" aria-hidden="true" style="color:#4b5563;">
                                        <path fill-rule="evenodd"
                                          d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314" />
                                      </svg>
                                      <% } %>
                                        <span class="stat-num like-count">
                                          <%= (t.likes || []).length %>
                                        </span>


                                        <!-- comments -->
                                        <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15"
                                          fill="currentColor" class="bi bi-chat-fill" aria-hidden="true"
                                          style="color:#4b5563;" viewBox="0 0 16 16">
                                          <path
                                            d="M8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6-.097 1.016-.417 2.13-.771 2.966-.079.186.074.394.273.362 2.256-.37 3.597-.938 4.18-1.234A9 9 0 0 0 8 15" />
                                        </svg>
                                        <span class="comment-count">
                                          <%= (t.replies || []).length %>
                                        </span>


                                        <!-- views -->
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon-inline bi bi-eye-fill"
                                          style="color:#4b5563;" viewBox="0 0 16 16" aria-hidden="true">
                                          <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0" />
                                          <path
                                            d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8m8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7" />
                                        </svg>
                                        <span class="stat-num">
                                          <%= (typeof t.views==='number' ) ? t.views : 0 %>
                                        </span>

                                        <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏•‡∏Å‡πå (‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ JS ‡∏à‡∏±‡∏ö) -->
                                        <button type="button" class="like-btn<%= likedByMe ? ' liked' : '' %>"
                                          data-thread-id="<%= t._id %>" aria-label="like"
                                          style="display:none;">‚ô•</button>
                              </p>

                              <% if (Array.isArray(t.tags) && t.tags.length) { %>
                                <div class="tags">
                                  <% t.tags.forEach(tag=> { %>
                                    <span class="tag">
                                      <%= tag %>
                                    </span>
                                    <% }) %>
                                </div>
                                <% } %>
                        </div>
                </a>
              </div>
              <% }); %>
          </section>
  </main>

  <% if (currentUser){ %>
    <a href="/threads/new" class="fab" aria-label="‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà">
      <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true">
        <path d="M11 5a1 1 0 0 1 2 0v6h6a1 1 0 1 1 0 2h-6v6a1 1 0 1 1-2 0v-6H5a1 1 0 1 1 0-2h6V5z" />
      </svg>
    </a>
    <% } %>

      <script>
        (function () {
          function timeAgo(input) {            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 
            const date = new Date(input);      // ‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏ï‡∏£‡∏¥‡∏á/‡πÄ‡∏•‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô Date
            const diffSec = Math.round((Date.now() - date.getTime()) / 1000);
            // ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏±‡∏ö input (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
            const abs = Math.abs(diffSec);     // ‡πÄ‡∏≠‡∏≤‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏Å‡∏ì‡∏ë‡πå
            if (abs < 45)                      // ‡∏ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 45 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
              return diffSec >= 0 ? "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà" : "‡∏≠‡∏µ‡∏Å‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà"; // ‡∏≠‡∏î‡∏µ‡∏ï/‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï ‡∏™‡∏±‡πâ‡∏ô ‡πÜ

            const units = [                    // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏ç‡πà‚Üí‡πÄ‡∏•‡πá‡∏Å (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢)
              { s: 31536000, k: "‡∏õ‡∏µ" },
              { s: 2592000, k: "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" },
              { s: 604800, k: "‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå" },
              { s: 86400, k: "‡∏ß‡∏±‡∏ô" },
              { s: 3600, k: "‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á" },
              { s: 60, k: "‡∏ô‡∏≤‡∏ó‡∏µ" },
              { s: 1, k: "‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ" },
            ];
            for (const u of units) {           // ‡∏´‡∏≤ ‚Äú‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‚Äù
              if (abs >= u.s) {
                const n = Math.floor(abs / u.s); // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡πâ‡∏ô ‡πÜ
                return diffSec >= 0 ? `${n} ${u.k}` : ` ${n} ${u.k}`;
                // ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢ ‡πÜ (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ ‚Äú‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß/‡∏≠‡∏µ‡∏Å‚Äù)
              }
            }
            return "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà";
          }

          function updateAll() {               // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∏‡∏Å .post-time
            document.querySelectorAll('.post-time[data-time]').forEach(el => {
              el.textContent = timeAgo(el.getAttribute('data-time')); // ‡∏≠‡πà‡∏≤‡∏ô data-time ‚Üí ‡πÅ‡∏õ‡∏•‡∏á ‚Üí ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            });
          }

          updateAll();                         // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î
          setInterval(updateAll, 60000);       // ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å 60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        })();
      </script>

</body>

</html>