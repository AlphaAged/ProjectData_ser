<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CP KKU Study Notes</title>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    .meta { color:#6b7280; margin:.25rem 0 .75rem; }
    .stats { display:flex; align-items:center; gap:16px; color:#6b7280; margin:.5rem 0 1rem; }
    .stat { display:inline-flex; align-items:center; gap:6px; }
    .stat svg { width:16px; height:16px; vertical-align:middle; }
    .stat svg path { fill:currentColor; }

    .actions-row { display:flex; flex-wrap:wrap; gap:.5rem; margin: .5rem 0 1rem; }
    .btn { padding:8px 12px; border-radius:8px; border:1px solid #d1d5db; background:#f9fafb; color:#374151; text-decoration:none; cursor:pointer; }
    .btn:hover { background:#eef2f7; }
    .btn.primary { border-color:#0d63a5; background:#0d63a5; color:#fff; }
    .btn.danger  { border-color:#dc2626; background:#fee2e2; color:#b91c1c; }
    .btn.link    { background:transparent; border-color:#d1d5db; }
    .muted { color:#6b7280; }

    .comments { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:.75rem; }
    .comment { padding:.5rem 0; border-bottom:1px solid #f1f5f9; }
    .comment:last-child { border-bottom:0; }
    .comment-meta { display:flex; align-items:center; gap:.4rem; color:#6b7280; font-size:.92rem; margin-bottom:.25rem; }
    .comment-author, .comment-author a { color:#0d63a5; font-weight:600; }
    textarea[name="body"] { width:100%; min-height:80px; padding:.6rem .75rem; border:1px solid #d1d5db; border-radius:8px; outline:none; }
    textarea[name="body"]:focus { border-color:#0d63a5; box-shadow:0 0 0 3px rgba(13,99,165,.15); }
    .row { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
  </style>
</head>
<body>

<main class="container">
  <h2><%= thread.title %></h2>

  <p class="meta">
    โดย <%= (thread.author && thread.author.username) ? thread.author.username : 'ผู้ใช้' %>
    · <%= new Date(thread.createdAt).toLocaleString('th-TH', { dateStyle:'medium', timeStyle:'short' }) %>
  </p>

  <!-- แถบสถิติ -->
  <div class="stats">
    <span class="stat" title="ถูกใจ">
      <svg viewBox="0 0 16 16" aria-hidden="true"><path d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"/></svg>
      <span><%= (thread.likes && thread.likes.length) ? thread.likes.length : 0 %></span>
    </span>
    <span class="stat" title="คอมเมนต์">
      <svg viewBox="0 0 16 16" aria-hidden="true"><path d="M8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6-.097 1.016-.417 2.13-.771 2.966-.079.186.074.394.273.362 2.256-.37 3.597-.938 4.18-1.234A9 9 0 0 0 8 15"/></svg>
      <span><%= (thread.replies && thread.replies.length) ? thread.replies.length : 0 %></span>
    </span>
    <span class="stat" title="จำนวนดู">
      <svg viewBox="0 0 16 16" aria-hidden="true"><path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8m8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7"/></svg>
      <span><%= (typeof thread.views === 'number') ? thread.views : 0 %></span>
    </span>
  </div>

  <p><%= thread.body %></p>

  <!-- ปุ่มการกระทำ -->
  <div class="actions-row">
    <% if (currentUser) { %>
      <form method="post" action="/threads/<%= thread._id %>/like" style="display:inline">
        <button class="btn primary" type="submit">ถูกใจ</button>
      </form>
    <% } %>

    <% if (currentUser && (String(currentUser.id) === String(thread.author._id) || currentUser.role === 'admin')) { %>
      <!-- ปุ่มแก้ไข (ต้องมี route /threads/:id/edit และอัปเดตข้อมูลด้วย) -->
      <a class="btn" href="/threads/<%= thread._id %>/edit">แก้ไข</a>

      <form method="post" action="/threads/<%= thread._id %>/delete" style="display:inline"
            onsubmit="return confirm('แน่ใจว่าจะลบกระทู้นี้?');">
        <button class="btn danger" type="submit">ลบกระทู้</button>
      </form>
    <% } else if (currentUser) { %>
      <a class="btn link" href="/threads/<%= thread._id %>/report">รายงาน</a>
    <% } %>
  </div>

  <hr/>

  <!-- คอมเมนต์ -->
  <h3>คำตอบ (<%= (thread.replies && thread.replies.length) ? thread.replies.length : 0 %>)</h3>

  <ul class="comments">
    <% if (thread.replies && thread.replies.length) { %>
      <% for (var i = 0; i < thread.replies.length; i++) {
           var r = thread.replies[i];
           var rName = (r.author && r.author.username) ? r.author.username : 'ผู้ใช้';
      %>
        <li class="comment">
          <div class="comment-meta">
            <b class="comment-author"><%= rName %></b>
            <span class="muted">· <%= new Date(r.createdAt).toLocaleString('th-TH', { dateStyle:'medium', timeStyle:'short' }) %></span>
          </div>
          <div class="comment-body"><%= r.body %></div>
        </li>
      <% } %>
    <% } else { %>
      <li class="comment muted">ยังไม่มีคำตอบ</li>
    <% } %>
  </ul>

  <% if (currentUser){ %>
    <form method="post" action="/threads/<%= thread._id %>/replies" style="margin-top:.75rem">
      <textarea name="body" rows="3" required placeholder="พิมพ์คำตอบของคุณ..."></textarea>
      <div class="row">
        <button class="btn primary" type="submit">ตอบ</button>
      </div>
    </form>
  <% } else { %>
    <p class="muted">ต้องเข้าสู่ระบบเพื่อแสดงความคิดเห็น</p>
  <% } %>
</main>

</body>
</html>
