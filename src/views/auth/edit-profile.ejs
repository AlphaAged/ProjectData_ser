<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>แก้ไขโปรไฟล์ · CP KKU Study Notes</title>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    :root{
      --brand:#0d63a5;
      --muted:#6b7280;
      --ink:#111827;
      --border:#e5e7eb;
      --card:#fff;
      --bg:#f8fafc;
    }
    body{ background:var(--bg); }
    .wrap{
      max-width: 880px;
      margin: 0 auto;
      padding: 16px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:0 4px 14px rgba(2,6,23,.05);
      overflow:hidden;
    }

    .card-head{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:baseline; gap:10px; flex-wrap:wrap;
    }
    .title{
      margin:0; font-size:1.4rem; color:#0f3d7a; font-weight:800;
    }
    .hint{ color:var(--muted); }

    .card-body{ padding:16px; }

    .profile-form{
      display:flex; flex-direction:column; gap:16px;
    }

    .grid{
      display:grid; gap:12px;
      grid-template-columns: 1fr;
    }
    @media (min-width:720px){
      .grid.two{ grid-template-columns: 1fr 1fr; }
    }

    label{ display:block; font-weight:600; color:var(--ink); margin:0 0 6px; }
    .field{
      display:flex; flex-direction:column;
    }
    .input, .select, .textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff; color:var(--ink);
      outline:none;
      transition:border-color .12s ease, box-shadow .12s ease;
      box-sizing: border-box;
    }
    .input:focus, .select:focus, .textarea:focus{
      border-color:var(--brand);
      box-shadow:0 0 0 3px rgba(13,99,165,.12);
    }
    .textarea{ min-height:120px; resize:vertical; }

    .help{ color:var(--muted); font-size:.9rem; margin-top:6px; }

    .actions{
      display:flex; gap:10px; justify-content:flex-end; padding-top:6px;
    }
    .btn{
      padding:10px 14px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#f9fafb; color:#374151;
      cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{ background:#eef2f7; }
    .btn.primary{ border-color:var(--brand); background:var(--brand); color:#fff; }
    .btn.primary[disabled]{ opacity:.7; cursor:not-allowed; }
    .btn.link{ background:transparent; }
    .alert{
      margin: 0 0 12px;
      padding:10px 12px;
      border:1px solid #dbeafe; background:#eff6ff; color:#0f3d7a;
      border-radius:10px;
    }
  </style>
</head>
<body>
  <main class="wrap">
    <% if (message){ %><div class="alert"><%= message %></div><% } %>

    <section class="card">
      <div class="card-head">
        <h1 class="title">แก้ไขโปรไฟล์ของฉัน</h1>
      </div>

      <div class="card-body">
        <form method="post" action="/edit-profile" class="profile-form" id="profileForm" novalidate>
          <!-- แถวที่ 1 -->
          <div class="grid two">
            <div class="field">
              <label for="username">ชื่อผู้ใช้</label>
              <input id="username" name="username" class="input" value="<%= user.username %>" required minlength="2" maxlength="40" />
              <div class="help">ความยาว 2–40 ตัวอักษร</div>
            </div>

            <div class="field">
              <label for="email">อีเมล</label>
              <input id="email" name="email" class="input" value="<%= user.email %>" type="email" required />
            </div>
          </div>

          <!-- แถวที่ 2 -->
          <div class="grid two">
            <div class="field">
              <label for="program">สาขา/โปรแกรม</label>
              <select id="program" name="program" class="select">
                <option value="">-- เลือกสาขา --</option>
                <option value="CS"  <%= String(user.program||'') === 'CS'  ? 'selected' : '' %> >CS</option>
                <option value="IT"  <%= String(user.program||'') === 'IT'  ? 'selected' : '' %> >IT</option>
                <option value="GIS" <%= String(user.program||'') === 'GIS' ? 'selected' : '' %> >GIS</option>
                <option value="CY"  <%= String(user.program||'') === 'CY'  ? 'selected' : '' %> >CY</option>
                <option value="AI"  <%= String(user.program||'') === 'AI'  ? 'selected' : '' %> >AI</option>
              </select>
            </div>

            <div class="field">
              <label for="year">ชั้นปี</label>
              <select id="year" name="year" class="select">
                <option value="">-- เลือกชั้นปี --</option>
                <option value="1" <%= String(user.year||'') === '1' ? 'selected' : '' %>>1</option>
                <option value="2" <%= String(user.year||'') === '2' ? 'selected' : '' %>>2</option>
                <option value="3" <%= String(user.year||'') === '3' ? 'selected' : '' %>>3</option>
                <option value="4" <%= String(user.year||'') === '4' ? 'selected' : '' %>>4</option>
              </select>
            </div>
          </div>

          <!-- แนะนำตัว -->
          <div class="field">
            <label for="bio">แนะนำตัว</label>
            <textarea id="bio" name="bio" class="textarea" rows="6" maxlength="1000" placeholder="เล่าเกี่ยวกับตัวคุณ, ความสนใจ หรือสิ่งที่อยากแลกเปลี่ยนกับเพื่อน ๆ"><%= user.bio || '' %></textarea>
            <div class="help">สูงสุด 1000 ตัวอักษร</div>
          </div>

          <!-- ปุ่ม -->
          <div class="actions">
            <a id="cancelLink" class="btn link" href="/profile">ยกเลิก</a>
            <button id="saveBtn" class="btn primary" type="submit">บันทึก</button>
          </div>
        </form>
      </div>
    </section>
  </main>

  <script>
    // กันกดยกเลิกโดยไม่ตั้งใจ
    document.getElementById('cancelLink')?.addEventListener('click', function(e){
      const dirty = hasDirty();
      if (dirty && !confirm('ยกเลิกการแก้ไขและออกจากหน้านี้? การเปลี่ยนแปลงจะไม่ถูกบันทึก')) {
        e.preventDefault();
      }
    });

    // กันกดซ้ำ + trim ค่าก่อนส่ง + ตรวจง่าย ๆ
    const form = document.getElementById('profileForm');
    const saveBtn = document.getElementById('saveBtn');
    const initial = new FormData(form);

    function hasDirty(){
      const now = new FormData(form);
      for (const [k,v] of now.entries()){
        if ((initial.get(k) || '') !== (v || '')) return true;
      }
      return false;
    }

    form.addEventListener('submit', function(e){
      // trim ช่องข้อความหลัก
      ['username','email','bio'].forEach(id=>{
        const el = document.getElementById(id);
        if (el && typeof el.value === 'string') el.value = el.value.trim();
      });

      // validate พื้นฐาน
      const username = document.getElementById('username').value;
      const email    = document.getElementById('email').value;

      if (username.length < 2){
        e.preventDefault();
        alert('กรุณากรอกชื่อผู้ใช้อย่างน้อย 2 ตัวอักษร');
        return;
      }
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
        e.preventDefault();
        alert('รูปแบบอีเมลไม่ถูกต้อง');
        return;
      }

      // ป้องกันกดซ้ำ
      saveBtn.disabled = true;
      saveBtn.textContent = 'กำลังบันทึก...';
    });
  </script>
</body>
</html>
